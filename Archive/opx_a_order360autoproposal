CREATE OR REPLACE VIEW tableau.opx_a_order360autoproposal
(
  orderid,
  orderproductid,
  orderitempartid,
  parttoothstr,
  parttoothmask,
  partquantity,
  parttotalcharge,
  parttotaltax,
  toothlocation,
  toothtype,
  shade,
  productid,
  transactiontype,
  doctorid,
  patientname,
  dateindtslocal,
  dateinvoiceddtslocal,
  originfacilityid,
  productionfacilityid,
  pf_departmentid,
  pf_isactualunit,
  pf_productgroup,
  pf_productline,
  pf_producttype,
  sourcesystem,
  sourcesystemscanner,
  scansystem,
  designsystem,
  millsystem,
  blocksize,
  blockcolor,
  gotreturned,
  returntype,
  returnorderid,
  returnorderproductid,
  returnorderitempartid,
  returnorderdateindtslocal,
  returnorderdateinvoiceddtslocal,
  returnparttoothstr,
  returnparttoothmask,
  returnproductid,
  returntoothlocation,
  returntoothtype,
  returnremakeid,
  returnorderremakereason,
  returnorderremakereasoncategory,
  returnitemremakereason,
  returnitemremakereasoncategory,
  returnquantity,
  daysbeforereturn,
  totalreturncount,
  delaycount,
  delaytimeinminutes,
  inboundcarriername,
  inboundtrackingnumber,
  inboundturnaroundtimeindays,
  orderentryturnaroundtimeinhours,
  outboundcarriername,
  outboundtrackingnumber,
  outboundturnaroundtimeindays,
  doctorgroupid,
  practicename,
  totalmillcount,
  totalmillunits,
  totalmillminutes,
  totaldesigncount,
  totaldesignunits,
  totaldesignminutes,
  totalscancount,
  totalscanminutes,
  totalscanunits,
  blockheight,
  blockmaterial,
  scannermake,
  scannermodel,
  milllocationname,
  designlocationid,
  designlocationname,
  scanlocationid,
  scanlocationname,
  millendlocaldts,
  designendlocaldts,
  scanendlocaldts,
  scanmachineserial,
  inhousesale,
  blockserialnumber,
  millmachineserial,
  remillreason,
  totalremillunits,
  isautoproposal
)
AS 
 SELECT a.orderid, a.orderproductid, a.orderitempartid, a.parttoothstr, a.parttoothmask, a.partquantity, a.parttotalcharge, a.parttotaltax, a.toothlocation, a.toothtype, a.shade, a.productid, a.transactiontype, a.doctorid, a.patientname, a.dateindtslocal, a.dateinvoiceddtslocal, a.originfacilityid, a.productionfacilityid, a.pf_departmentid, a.pf_isactualunit, a.pf_productgroup, a.pf_productline, a.pf_producttype, a.sourcesystem, a.sourcesystemscanner, a.scansystem, a.designsystem, a.millsystem, a.blocksize, a.blockcolor, a.gotreturned, a.returntype, a.returnorderid, a.returnorderproductid, a.returnorderitempartid, a.returnorderdateindtslocal, a.returnorderdateinvoiceddtslocal, a.returnparttoothstr, a.returnparttoothmask, a.returnproductid, a.returntoothlocation, a.returntoothtype, a.returnremakeid, a.returnorderremakereason, a.returnorderremakereasoncategory, a.returnitemremakereason, a.returnitemremakereasoncategory, a.returnquantity, a.daysbeforereturn, a.totalreturncount, a.delaycount, a.delaytimeinminutes, a.inboundcarriername, a.inboundtrackingnumber, a.inboundturnaroundtimeindays, a.orderentryturnaroundtimeinhours, a.outboundcarriername, a.outboundtrackingnumber, a.outboundturnaroundtimeindays, a.doctorgroupid, a.practicename, a.totalmillcount, a.totalmillunits, a.totalmillminutes, a.totaldesigncount, a.totaldesignunits, a.totaldesignminutes, a.totalscancount, a.totalscanminutes, a.totalscanunits, a.blockheight, a.blockmaterial, a.scannermake, a.scannermodel, a.milllocationname, a.designlocationid, a.designlocationname, a.scanlocationid, a.scanlocationname, a.millendlocaldts, a.designendlocaldts, a.scanendlocaldts, a.scanmachineserial, a.inhousesale, a.blockserialnumber, a.millmachineserial, a.remillreason, a.totalremillunits, 
        CASE
            WHEN b.orderid IS NOT NULL THEN 1
            ELSE 0
        END AS isautoproposal
   FROM agg.order360infobypart a
   LEFT JOIN cp.autoproposal_dev b ON a.orderid = b.orderid
  WHERE a.dateindtslocal >= '2015-04-01 00:00:00'::timestamp without time zone;

COMMIT;
